# Pipeline Test Workflow
# Simple workflow to test GitHub Actions setup

name: Pipeline Test

on:
  push:
    branches: [main, develop, feature/*, test/*]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: read
  pull-requests: write

jobs:
  test-basic:
    name: Basic Pipeline Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Environment Info
        run: |
          echo "üöÄ GitHub Actions Pipeline Test"
          echo "================================"
          echo "Repository: ${{ github.repository }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Event: ${{ github.event_name }}"
          echo "Actor: ${{ github.actor }}"
          echo "Workflow: ${{ github.workflow }}"
          echo "Run ID: ${{ github.run_id }}"
          echo "Run Number: ${{ github.run_number }}"
          echo ""

      - name: Check Repository Structure
        run: |
          echo "üìÅ Repository Structure:"
          echo "======================="
          ls -la
          echo ""
          echo "üìÅ Infrastructure Files:"
          if [ -d "muykol-chatbot-infra" ]; then
            find muykol-chatbot-infra -name "*.tf" -type f | head -10
          else
            echo "No infrastructure directory found"
          fi
          echo ""
          echo "üìÅ Application Files:"
          if [ -d "muykol-chatbot-app" ]; then
            find muykol-chatbot-app -name "*.py" -type f | head -10
          else
            echo "No application directory found"
          fi

      - name: Test Infrastructure Validation
        run: |
          echo "üîß Testing Infrastructure Validation"
          echo "===================================="
          if [ -d "muykol-chatbot-infra" ]; then
            cd muykol-chatbot-infra
            
            # Check for required files
            echo "Checking for required Terraform files..."
            [ -f "main.tf" ] && echo "‚úÖ main.tf found" || echo "‚ùå main.tf missing"
            [ -f "variables.tf" ] && echo "‚úÖ variables.tf found" || echo "‚ùå variables.tf missing"
            [ -f "terraform.dev.tfvars" ] && echo "‚úÖ terraform.dev.tfvars found" || echo "‚ùå terraform.dev.tfvars missing"
            
            # Check modules
            echo ""
            echo "Checking modules..."
            [ -d "modules/vpc" ] && echo "‚úÖ VPC module found" || echo "‚ùå VPC module missing"
            [ -d "modules/cognito" ] && echo "‚úÖ Cognito module found" || echo "‚ùå Cognito module missing"
            [ -d "modules/dynamodb" ] && echo "‚úÖ DynamoDB module found" || echo "‚ùå DynamoDB module missing"
            [ -d "modules/sqs" ] && echo "‚úÖ SQS module found" || echo "‚ùå SQS module missing"
            [ -d "modules/iam" ] && echo "‚úÖ IAM module found" || echo "‚ùå IAM module missing"
          else
            echo "‚ùå Infrastructure directory not found"
          fi

      - name: Test Application Structure
        run: |
          echo "üêç Testing Application Structure"
          echo "==============================="
          if [ -d "muykol-chatbot-app" ]; then
            cd muykol-chatbot-app
            
            # Check for required files
            echo "Checking for required application files..."
            [ -f "requirements.txt" ] && echo "‚úÖ requirements.txt found" || echo "‚ùå requirements.txt missing"
            [ -f "standalone_app.py" ] && echo "‚úÖ standalone_app.py found" || echo "‚ùå standalone_app.py missing"
            
            # Check application structure
            echo ""
            echo "Checking application structure..."
            [ -d "faith_motivator_chatbot" ] && echo "‚úÖ Main app directory found" || echo "‚ùå Main app directory missing"
            [ -d "tests" ] && echo "‚úÖ Tests directory found" || echo "‚ùå Tests directory missing"
            [ -d "design" ] && echo "‚úÖ Design directory found" || echo "‚ùå Design directory missing"
          else
            echo "‚ùå Application directory not found"
          fi

      - name: Test Python Syntax
        run: |
          echo "üêç Testing Python Syntax"
          echo "========================"
          if [ -d "muykol-chatbot-app" ]; then
            python3 -m py_compile muykol-chatbot-app/standalone_app.py && echo "‚úÖ standalone_app.py syntax OK" || echo "‚ùå standalone_app.py syntax error"
            
            # Test other Python files
            find muykol-chatbot-app -name "*.py" -type f | while read file; do
              python3 -m py_compile "$file" && echo "‚úÖ $file syntax OK" || echo "‚ùå $file syntax error"
            done | head -10
          else
            echo "‚ùå No Python files to test"
          fi

      - name: Pipeline Success
        run: |
          echo "üéâ Pipeline Test Results"
          echo "======================="
          echo "‚úÖ GitHub Actions is working correctly!"
          echo "‚úÖ Repository structure validated"
          echo "‚úÖ Infrastructure files detected"
          echo "‚úÖ Application files detected"
          echo "‚úÖ Python syntax validation completed"
          echo ""
          echo "üöÄ Ready to proceed with full CI/CD pipeline!"

  test-matrix:
    name: Matrix Test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: [dev, staging, prod]
        python-version: ["3.9", "3.10"]
    
    steps:
      - name: Matrix Test
        run: |
          echo "Testing environment: ${{ matrix.environment }}"
          echo "Python version: ${{ matrix.python-version }}"
          echo "‚úÖ Matrix strategy working correctly!"

  test-conditional:
    name: Conditional Test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Conditional Test
        run: |
          echo "This job runs only on push or manual trigger"
          echo "Event: ${{ github.event_name }}"
          echo "‚úÖ Conditional logic working correctly!"